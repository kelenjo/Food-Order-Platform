{% extends "partials/base.html" %}
{% block title %}Your Cart{% endblock %}
{% block body %}

<div class="container mt-5">
    <h1 class="text-center mb-5 fw-bold">Your Cart</h1>

    {% if cart_items %}
    <div class="row g-4">
        {% for item in cart_items %}
        <div class="col-md-6 col-lg-4">
            <div class="card h-100 shadow-lg border-0 cart-card">
                <img src="{{ url_for('static', filename='assets/' ~ item.products.image) }}"
                     class="card-img-top"
                     alt="{{ item.products.name }}"
                     style="height: 200px; object-fit: cover; cursor: pointer;"
                     onclick="window.location.href='{{ url_for('product.view', product_id=item.products.id) }}'">
                <div class="card-body d-flex flex-column">
                    <h5 class="card-title fw-bold">
                        <a href="{{ url_for('product.view', product_id=item.products.id) }}" class="text-decoration-none text-dark">
                            {{ item.products.name }}
                        </a>
                    </h5>
                    <p class="text-muted mb-1">Price: ${{ item.products.price }}</p>

                    <!-- Quantity Controls -->
                    <div class="d-flex align-items-center justify-content-between my-3">
                        <button class="btn btn-outline-secondary btn-sm qty-btn" data-action="decrease" data-id="{{ item.id }}">âˆ’</button>
                        <span class="mx-3 fw-bold fs-5" id="qty-{{ item.id }}">{{ item.quantity }}</span>
                        <button class="btn btn-outline-secondary btn-sm qty-btn" data-action="increase" data-id="{{ item.id }}">+</button>
                    </div>

                    <p class="fw-bold text-success mt-2">Subtotal: ${{ item.quantity * item.products.price }}</p>

                    <div class="mt-auto text-end">
                        <button class="btn btn-outline-danger btn-sm remove-item-btn" data-id="{{ item.id }}">
                            <i class="bi bi-trash me-1"></i> Remove
                        </button>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Total Price Card -->
    <div class="card shadow-sm border-0 mt-5">
        <div class="card-body d-flex justify-content-between align-items-center">
            <h4 class="fw-bold mb-0">Total: ${{ total_price }}</h4>
            <a href="#" class="btn btn-lg btn-success px-4">Checkout</a>
        </div>
    </div>

    {% else %}
    <div class="text-center mt-5">
        <h3 class="fw-bold">ðŸ›’ Your cart is empty!</h3>
        <a href="{{ url_for('product.menu') }}" class="btn btn-primary mt-3 px-4">Go to Menu</a>
    </div>
    {% endif %}
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
async function removeItem(itemId) {
    const result = await Swal.fire({
        title: 'Remove this item?',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#6c757d',
        confirmButtonText: 'Yes, remove it'
    });

    if (result.isConfirmed) {
        const response = await fetch('/remove_from_cart', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({item_id: itemId})
        });
        if ((await response.json()).status === 'success') {
            location.reload();
        }
    }
}

// Trash button event
document.querySelectorAll('.remove-item-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        removeItem(this.dataset.id);
    });
});

// Quantity controls
document.querySelectorAll('.qty-btn').forEach(btn => {
    btn.addEventListener('click', async function() {
        const itemId = this.dataset.id;
        const action = this.dataset.action;
        const qtySpan = document.getElementById('qty-' + itemId);
        let newQty = parseInt(qtySpan.textContent);

        if (action === "increase") {
            newQty++;
        } else if (action === "decrease") {
            if (newQty > 1) {
                newQty--;
            } else {
                // Reuse same remove dialog when qty = 1
                await removeItem(itemId);
                return; // stop after removal
            }
        }

        qtySpan.textContent = newQty;

        await fetch('/update_cart_quantity', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({item_id: itemId, quantity: newQty})
        });
        location.reload();
    });
});
</script>


<!-- Styling -->
<style>
.cart-card {
    transition: transform 0.3s, box-shadow 0.3s;
}
.cart-card:hover {
    transform: translateY(-6px) scale(1.02);
    box-shadow: 0 10px 20px rgba(0,0,0,0.15);
}
.qty-btn {
    width: 36px;
    height: 36px;
    font-size: 20px;
    font-weight: bold;
    line-height: 1;
    padding: 0;
}
</style>

{% endblock %}
